---
- name: Migrate VM from VMware to OpenShift Virtualization using MTV
  hosts: localhost
  gather_facts: no
  vars:
    mtv_namespace: "vm-migration"     # Namespace where MTV is installed
    vm_name: "application01"                   # Name of the VM to migrate
    migration_plan_name: "migration-p001"  # Name of the migration plan
    source_provider: "vmware" # Source VMware provider name in MTV
    target_provider: "ocp-virt"  # Target OpenShift Virtualization provider in MTV
    vmware_datacenter: "Datacenter"   # VMware datacenter
    vmware_cluster: "Cluster1"         # VMware cluster where the VM resides
    target_namespace: "vm-migration"   # Namespace in OpenShift for the migrated VM
    ocp_cluster_url: "https://api.ibmcoe.techmapps.local:6443"
    openshift_token: "sha256~RIPYdqWKQ_0r06B_yKF3Abuidk7IcFAuh3r04oHweIk"

  tasks:
    - name: Log in to OpenShift
      shell: >
        oc login --server={{ ocp_cluster_url }} --token={{ openshift_token }}  --insecure-skip-tls-verify=true

    - name: Create migration plan for the VM from VMware to OpenShift Virtualization
      shell: |
        oc create -f - <<EOF
        apiVersion: forklift.konveyor.io/v1beta1
        kind: Plan
        metadata:
          name: {{ migration_plan_name }}
          namespace: {{ mtv_namespace }}
        spec:
          targetProvider: {{ target_provider }}
          sourceProvider: {{ source_provider }}
          vms:
            - name: "{{ vm_name }}"
              datacenter: "{{ vmware_datacenter }}"
              cluster: "{{ vmware_cluster }}"
          map:
            namespace: "{{ target_namespace }}"
        EOF
      register: migration_plan_creation
      ignore_errors: yes
      tags:
        - migration_plan

    - name: Check if migration plan creation was successful
      debug:
        var: migration_plan_creation
      tags:
        - migration_plan

    - name: Start migration plan
      shell: |
        oc patch migrationplan {{ migration_plan_name }} -n {{ mtv_namespace }} --type='json' -p='[{"op": "add", "path": "/spec/migrate", "value": true}]'
      register: migration_plan_start
      ignore_errors: yes
      tags:
        - start_migration

    - name: Check if migration plan start was successful
      debug:
        var: migration_plan_start
      tags:
        - start_migration

    - name: Monitor migration plan status
      shell: |
        oc get migrationplan {{ migration_plan_name }} -n {{ mtv_namespace }} -o jsonpath='{.status.conditions[?(@.type=="Succeeded")].status}'
      register: migration_status
      until: migration_status.stdout == "True"
      retries: 30
      delay: 60
      tags:
        - monitor_migration

    - name: Verify migration status
      debug:
        var: migration_status
      tags:
        - monitor_migration
